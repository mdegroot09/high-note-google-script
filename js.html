<script>

window.addEventListener('load', load())

function load(){
  // Get user info
  google.script.run  
  // if successful, display the data 
  .withSuccessHandler(function(res){
    console.log(res.notes)
    document.notes = res.notes
    displayNotes(res.notes)
  })
  // if error
  .withFailureHandler(function(err){
    console.log("error occured", err);
  })
  .getNotes()
}

function displayNotes(notes){
  notes.forEach(function(a){
    let display = 'flex'
    if (a.show == false){
      display = 'none'
    }
    document.getElementById('displayNotes').innerHTML += (
      '<div class="newNote displayNote" id="entry' + a.id + '" style="display: ' + display + '" onClick="editEntry(' + a.id + ')">' +
        '<div style="width: 25%; max-width: 150px; display: flex; justify-content: flex-end;">' +
          '<select class="labelDropdown editDD display" id="label' + a.id + '" disabled>' +
            '<option value="0" class="optionText">General</option>' +
            '<option value="1" class="optionText">Closing Coordinators</option>' +
            '<option value="2" class="optionText">Listing Coordinators</option>' +
            '<option value="3" class="optionText">MoBro</option>' +
            '<option value="4" class="optionText">ReBro Buy</option>' +
            '<option value="5" class="optionText">ReBro Sell</option>' +
            '<option value="6" class="optionText">Sales Team</option>' +
            '<option value="7" class="optionText">AZ</option>' +
            '<option value="8" class="optionText">CO</option>' +
            '<option value="9" class="optionText">ID</option>' +
            '<option value="10" class="optionText">NV</option>' +
            '<option value="11" class="optionText" selected>All</option>' +
          '</select>' +
        '</div>' +
        '<div style="width: calc(50vw - 25px); padding-left: 6px; display: flex; justify-content: center;">' +
          '<textarea class="addText display" id="note' + a.id + '" oninput="autoGrow(this)" style="width: 100%; max-width: 100%;" disabled>' + a.note + '</textarea>' +
        '</div>' +
        '<div style="width: 25%; max-width: 150px; display: flex; justify-content: flex-start;">' +
          '<select class="labelDropdown editDD display" id="type' + a.id + '" disabled>' +
            '<option value="0" class="optionText">Note</option>' +
            '<option value="1" class="optionText">To-do</option>' +
          '</select>' +
        '</div>' +
      '</div>' +
      '<br>'
    )
    document.getElementById('label' + a.id).value = a.label
    autoGrow(document.getElementById('note' + a.id))
    document.getElementById('type' + a.id).value = a.type
  })
}

function editEntry(id){
  console.log('the id is ' + id)
  document.activeId = id
  document.getElementById('entry' + id).style.zIndex = 2
  document.getElementById('clickContainer').style.display = 'block'
  
  // Enable each container
  document.getElementById('label' + id).disabled = false
  document.getElementById('note' + id).disabled = false
  document.getElementById('type' + id).disabled = false
  
  // Remove display class from containers
  document.getElementById('label' + id).classList.remove('display')
  document.getElementById('note' + id).classList.remove('display')
  document.getElementById('type' + id).classList.remove('display')
  
  // Place cursor at end of textarea
  activateCursor(id)
  
  // Save on tab or enter
  document.getElementById('note' + id).addEventListener('keydown', function(event){
    if (event.keyCode == 9) {
      event.preventDefault();
      saveEntry(id)
    }
  })
  
  // Remove click listener from element
  document.getElementById('entry' + id).onclick = ''
}

function activateCursor(id) {
  let e = document.getElementById('note' + id)
  e.focus()
  e.setSelectionRange(e.value.length,e.value.length)
}

function saveEntry(id){
  console.log('container closed')
  document.getElementById('entry' + id).style.zIndex = 0
  document.getElementById('clickContainer').style.display = 'none'
  
  // Disable each container
  document.getElementById('label' + id).disabled = true
  document.getElementById('note' + id).disabled = true
  document.getElementById('type' + id).disabled = true
  
  // Add display class to containers
  document.getElementById('label' + id).classList.add('display')
  document.getElementById('note' + id).classList.add('display')
  document.getElementById('type' + id).classList.add('display')
  
  // Auto resize textarea
  autoGrow(document.getElementById('note' + id))
  
  // Add click listener to element
  document.getElementById('entry' + id).addEventListener('click', function(event){
     event.preventDefault();
     editEntry(id)
  })
}

function autoGrow(e) {
  e.style.height = "17px";
  e.style.height = (e.scrollHeight)+"px";
  console.log(e.value)
  if (document.getElementById('newText').value){
    showSaveCancelBtns()
  } else {
    hideSaveCancelBtns()
  }
}

function showSaveCancelBtns(){
  document.getElementById('newSaveCancel').style.display = 'flex'
}

function hideSaveCancelBtns(){
  document.getElementById('newSaveCancel').style.display = 'none'
}

function saveNewNote(){
  let e = document.getElementById('newLabel')
  console.log(e.options[e.selectedIndex].text)
  let text = document.getElementById('newText').value
  console.log(text)
  e = document.getElementById('newType')
  console.log(e.options[e.selectedIndex].text)
  
  cancelNewNote()
}

function cancelNewNote(){
  document.getElementById('newLabel').value = 0
  document.getElementById('newText').value = ''
  document.getElementById('newText').style.height = '20px'
  document.getElementById('newType').value = 0
  
  hideSaveCancelBtns()
}

</script>