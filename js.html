<script>

window.addEventListener('load', load())

function load(){
  // run google script
  google.script.run  
  // if successful, display the data 
  .withSuccessHandler(function(res){
    console.log(res.notes)
    document.notes = res.notes
    displayNotes(res.notes)
    createShiftKeyListeners()
  })
  // if error
  .withFailureHandler(function(err){
    console.log("error occured", err);
  })
  .getNotes()
}

function createShiftKeyListeners(){

  // Set shiftDown on keydown
  document.querySelector('body').addEventListener('keydown', function(e){
    
    // shift keydown becomes true
    if (e.keyCode == 16){
      document.shiftDown = true
    }
  })
    
  // Clear shiftDown on keyup
  document.querySelector('body').addEventListener('keyup', function(e){

    // shift keydown becomes false
    if (e.keyCode == 16){
      document.shiftDown = false
    }
  })
}

function displayNotes(notes){
  notes.forEach(function(a){
    let display = 'flex'
    if (a.show == false){
      display = 'none'
    }
    document.getElementById('displayNotes').innerHTML += (
      '<div class="newNote displayNote" id="entry' + a.id + '" style="display: ' + display + '; position: relative;">' +
        '<div id="clickEntry' + a.id + '" style="position: absolute; height: 100%; width: 100%;" onClick="editEntry(' + a.id + ')"></div>' +
        '<div style="width: 25%; max-width: 150px; display: flex; justify-content: flex-end;" enterKeyHint="' + a.id + '">' +
          '<select class="labelDropdown editDD display" id="label' + a.id + '" disabled>' +
            '<option value="0" class="optionText">General</option>' +
            '<option value="1" class="optionText">Closing Coordinators</option>' +
            '<option value="2" class="optionText">Listing Coordinators</option>' +
            '<option value="3" class="optionText">MoBro</option>' +
            '<option value="4" class="optionText">ReBro Buy</option>' +
            '<option value="5" class="optionText">ReBro Sell</option>' +
            '<option value="6" class="optionText">Sales Team</option>' +
            '<option value="7" class="optionText">AZ</option>' +
            '<option value="8" class="optionText">CO</option>' +
            '<option value="9" class="optionText">ID</option>' +
            '<option value="10" class="optionText">NV</option>' +
            '<option value="11" class="optionText" selected>All</option>' +
          '</select>' +
        '</div>' +
        '<div style="width: calc(50vw - 25px); padding-left: 6px; display: flex; justify-content: center;">' +
          '<textarea class="addText display" id="note' + a.id + '" oninput="autoGrow(this)" style="width: 100%; max-width: 100%;" disabled>' + a.note + '</textarea>' +
        '</div>' +
        '<div style="width: 25%; max-width: 150px; display: flex; justify-content: flex-start;">' +
          '<select class="labelDropdown editDD display" id="type' + a.id + '" disabled>' +
            '<option value="0" class="optionText">Note</option>' +
            '<option value="1" class="optionText">To-do</option>' +
          '</select>' +
        '</div>' +
      '</div>' +
      '<br>'
    )
    document.getElementById('label' + a.id).value = a.label
    autoGrow(document.getElementById('note' + a.id))
    document.getElementById('type' + a.id).value = a.type
  })
}

function editEntry(id){
  console.log('the id is ' + id)
  document.activeId = id
  document.getElementById('clickEntry' + id).style.display = 'none'
  document.getElementById('entry' + id).style.zIndex = 2
  document.getElementById('clickContainer').style.display = 'block'
  
  // Enable each container
  document.getElementById('label' + id).disabled = false
  document.getElementById('note' + id).disabled = false
  document.getElementById('type' + id).disabled = false
  
  // Remove display class from containers
  document.getElementById('label' + id).classList.remove('display')
  document.getElementById('note' + id).classList.remove('display')
  document.getElementById('type' + id).classList.remove('display')
  
  // Place cursor at end of textarea
  activateCursor(id)
  
  // Save on tab or enter
  document.getElementById('type' + id).addEventListener('keydown', function(e){
      
    // if tab and shiftkey is not true
    if (e.keyCode == 9 && document.shiftDown !== true) {
      e.preventDefault();
      document.shiftDown = false
      return saveEntry(id)
    }
  })
}

function clickListener(event){
  let id = document.activeId
  console.log(event)
  event.preventDefault();
  editEntry(id)
}

function activateCursor(id) {
  let e = document.getElementById('note' + id)
  e.focus()
  e.setSelectionRange(e.value.length,e.value.length)
}

function saveEntry(id){
  console.log('container closed, id: ' + id)
  document.getElementById('clickEntry' + id).style.display = 'block'
  document.getElementById('entry' + id).style.zIndex = 0
  document.getElementById('clickContainer').style.display = 'none'
  
  // Disable each container
  document.getElementById('label' + id).disabled = true
  document.getElementById('note' + id).disabled = true
  document.getElementById('type' + id).disabled = true
  
  // Add display class to containers
  document.getElementById('label' + id).classList.add('display')
  document.getElementById('note' + id).classList.add('display')
  document.getElementById('type' + id).classList.add('display')
  
  // Auto resize textarea
  autoGrow(document.getElementById('note' + id))
}

function autoGrow(e) {
  e.style.height = "17px";
  e.style.height = (e.scrollHeight)+"px";
  console.log(e.value)
  if (document.getElementById('newText').value){
    showSaveCancelBtns()
  } else {
    hideSaveCancelBtns()
  }
}

function showSaveCancelBtns(){
  document.getElementById('newSaveCancel').style.display = 'flex'
}

function hideSaveCancelBtns(){
  document.getElementById('newSaveCancel').style.display = 'none'
}

function saveNewNote(){
  let label = document.getElementById('newLabel').value
  let note = document.getElementById('newText').value
  let type =  document.getElementById('newType').value
  
  let newEntry = {
    isNewEntry: true,
    label: label,
    note: note,
    created: Number(new Date()),
    type: type,
    show: true
  }
  
  runAddEditEntry(newEntry)
  cancelNewNote()
}

function cancelNewNote(){
  document.getElementById('newLabel').value = 0
  document.getElementById('newText').value = ''
  document.getElementById('newText').style.height = '20px'
  document.getElementById('newType').value = 0
  
  hideSaveCancelBtns()
}

function runAddEditEntry(entry){
  // run google script
  google.script.run  
  // if successful, display the data 
  .withSuccessHandler(function(res){
    console.log(res)
    
  })
  // if error
  .withFailureHandler(function(err){
    console.log("error occured", err);
  })
  .addEditEntry(entry)
}

</script>